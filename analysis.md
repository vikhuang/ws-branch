# 2345 券商交易行為分析

資料期間：2023-02-06 ~ 2026-02-04（729 個交易日）
股價變化：257.5 → 1185.0（+360%）

## 研究問題

> 哪些券商的交易行為顯示出持續的判斷力？能否打敗 Buy & Hold？

## 方法論演進

### 第一版：單純相關係數（已棄用）

```python
corr(net_buy[broker], price_return)
```

**問題**：
1. **多重比較謬誤**：865 個券商 × p<0.05 = 預期 43 個假陽性
2. **相關 ≠ 因果**：同日相關可能是價格影響交易，而非交易影響價格
3. **市佔率忽略**：0.4% 市佔的分點不可能「影響」價格

### 第二版：Lead-Lag 分析

區分兩種相關：

| 類型 | 公式 | 意義 |
|------|------|------|
| **Lead** | corr(net_buy[t-1], return[t]) | 昨日淨買 → 今日報酬（預測能力） |
| **Lag** | corr(return[t-1], net_buy[t]) | 昨日報酬 → 今日淨買（反應行為） |

**假設**：若券商能「影響」價格，Lead 係數應顯著為正。

## 資料處理

### 變數定義

```python
net_buy = buy_shares - sell_shares        # 淨買張數
return_rate = (close[t] - close[t-1]) / close[t-1]  # 日報酬率
```

### 篩選條件

- 市佔率 ≥ 2%（減少多重比較問題）
- 交易日數 ≥ 100 天（確保樣本量）

篩選後剩餘：7 個券商分點

## 統計顯著性標準

| 門檻 | 值 | 說明 |
|------|-----|------|
| 相關係數 | \|r\| > 0.15 | 實務顯著性 |
| p-value | p < 0.01 | 統計顯著性（Bonferroni 校正後） |
| 樣本數 | n > 100 | 避免小樣本偏誤 |

## 分析結果

### 市佔率 ≥2% 券商

| 券商 | 市佔率 | Lead | Lag | 交易風格 |
|------|--------|------|-----|----------|
| 凱基-台北 | 8.2% | -0.03 | **-0.18** | 逆勢操作 |
| 瑞銀 | 5.1% | +0.02 | **-0.15** | 逆勢操作 |
| 高盛 | 4.3% | +0.11 | -0.08 | 無明顯模式 |
| 美林 | 3.8% | +0.05 | **+0.22** | 順勢追蹤 |
| 摩根大通 | 3.2% | -0.01 | **-0.21** | 強逆勢 |
| 元大-台北 | 2.8% | +0.03 | +0.08 | 無明顯模式 |
| 富邦-台北 | 2.1% | -0.02 | +0.11 | 略順勢 |

### Lead 係數統計檢定

| 券商 | Lead | t-stat | p-value | 顯著？ |
|------|------|--------|---------|--------|
| 高盛 | +0.11 | 1.56 | 0.12 | ❌ |
| 美林 | +0.05 | 0.71 | 0.48 | ❌ |
| 元大-台北 | +0.03 | 0.42 | 0.67 | ❌ |
| 其他 | <0.03 | <0.5 | >0.5 | ❌ |

**結論：沒有任何券商的 Lead 係數達到統計顯著。**

## 懷疑與限制

### 1. 資料顆粒度不足

現有資料為「日頻」彙總，無法觀察：
- 盤中交易時序（誰先買、誰跟進）
- 委託簿深度變化
- 大單拆分行為

**影響**：無法區分「造成價格變動」vs「被價格變動吸引」

### 2. 同日相關的詮釋困難

```
同日相關高 ≠ 影響價格

可能解釋：
A. 券商大買 → 價格上漲（券商影響價格）
B. 價格上漲 → 券商追買（價格影響券商）
C. 某消息 → 同時造成價格漲 + 券商買（共同因子）
```

日頻資料無法區分 A/B/C。

### 3. 券商背後的異質性

「凱基-台北」可能包含：
- 自營部門
- 多個法人客戶
- 散戶經紀

單一券商代碼的淨買是**淨額**，掩蓋了內部對作。

### 4. 存活者偏誤

分析期間為 2023-2026，這段期間：
- 2345 股價區間：247 ~ 1095
- 波動率相對穩定

結論可能不適用於：
- 股災期間
- 流動性枯竭時期
- 其他股票

## 可靠推論

### ✅ 可以說的

1. **交易風格分類**
   - 凱基-台北、瑞銀、摩根大通：逆勢操作者（跌買漲賣）
   - 美林：順勢追蹤者（漲買跌賣）
   - 高盛、元大、富邦：無明顯模式

2. **長期持倉方向**
   ```
   累計淨買（看多）:
   - 瑞銀: +12,847 張
   - 高盛: +8,234 張

   累計淨賣（看空/減持）:
   - 摩根士丹利: -5,621 張
   - 美林: -3,892 張
   ```

3. **市場結構**
   - 前 10 大券商佔總交易量 45%
   - 外資券商（瑞銀、高盛、美林等）合計佔 25%
   - 內資主力（凱基、元大、富邦）合計佔 20%

### ❌ 不能說的

1. ~~「跟著 X 券商買就能獲利」~~
   - 沒有券商有顯著預測能力

2. ~~「X 券商能影響/操控價格」~~
   - Lead 係數皆不顯著
   - 同日相關無法證明因果

3. ~~「小券商的相關係數有意義」~~
   - 多重比較問題
   - 低市佔率 = 低影響力

4. ~~「這個分析結果可推廣到其他股票」~~
   - 只分析了 2345 一檔
   - 不同股票有不同的投資人結構

## Alpha 分析（執行品質）

### 方法論演進

#### v1（已棄用）：與期末價比較

```
alpha = trade_return - (期末價 - 買入價) / 買入價
```

**問題**：把當沖交易跟持有三年比較，邏輯不通。

#### v2（正確）：與同期間市場報酬比較

```
對每筆平倉：
  trade_return = (執行賣價 - 執行買價) / 執行買價
  benchmark_return = (賣出日收盤 - 買入日收盤) / 買入日收盤
  alpha = trade_return - benchmark_return
```

**意義**：衡量執行價格是否優於市場收盤價。

### 資料結構

在 `pnl_engine.py` 中新增：

```python
@dataclass
class Lot:
    shares: int
    cost_per_share: float
    buy_date: str  # 追蹤買入日期

@dataclass
class ClosedTrade:
    """每筆平倉記錄"""
    symbol: str
    broker: str
    shares: int
    buy_date: str
    buy_price: float
    sell_date: str
    sell_price: float
    realized_pnl: float
    trade_type: str  # "long" or "short"
```

新增輸出：`closed_trades.parquet`（660,573 筆平倉記錄）

### 分析結果

| 統計 | 數值 |
|------|------|
| 分析券商數 | 868（交易額 ≥ 1000萬） |
| Alpha > 0 | 247 (28.5%) |
| Alpha < 0 | 621 (71.5%) |
| 平均 Alpha | -0.097% |
| 中位數 Alpha | -0.091% |
| **全市場 Alpha 總和** | **+0.26 億** |

### 核心發現

**1. Alpha 範圍很小（-1.88% ~ +1.72%）**

這是合理的：執行價格與收盤價的差異本來就不大。

**2. 大部分券商（71.5%）執行價格略劣於收盤價**

這符合預期：
- 買入時通常追價（高於收盤）
- 賣出時通常殺價（低於收盤）

**3. 主要券商 Alpha**

| 券商 | Alpha | Alpha 金額 | 解讀 |
|------|-------|------------|------|
| 土銀 | +1.17% | +0.21 億 | 執行價格最優 |
| 美林 | +0.13% | +1.45 億 | 略優（大量交易） |
| 961H 富邦總行 | +0.37% | +0.04 億 | 略優 |
| 群益金鼎 | -0.13% | -0.25 億 | 略劣 |
| 大和國泰 | -0.31% | -0.26 億 | 略劣 |

### Alpha 的正確解讀

| Alpha | 意義 | 來源 |
|-------|------|------|
| 正 | 執行價優於收盤價 | 買在低點、賣在高點（盤中） |
| 負 | 執行價劣於收盤價 | 買在高點、賣在低點（盤中） |
| 零 | 執行價等於收盤價 | 以收盤價成交 |

### 範例計算

```
買入日：2025-10-16   執行買價：1025   收盤價：1000（買貴 2.5%）
賣出日：2026-01-13   執行賣價：1190   收盤價：1180（賣好 0.8%）

交易報酬 = (1190 - 1025) / 1025 = +16.1%
基準報酬 = (1180 - 1000) / 1000 = +18.0%
Alpha = 16.1% - 18.0% = -1.9%
```

**結論**：執行價格比收盤價差了 1.9%，主要因為買入時付了溢價。

## 後續研究方向

若要更嚴謹回答「誰影響價格」：

| 方法 | 所需資料 | 可解決問題 |
|------|----------|------------|
| **逐筆委託分析** | 交易所 Level 3 資料 | 時序因果 |
| **Granger 因果檢定** | 現有資料即可 | 統計因果（弱） |
| **事件研究法** | 大單交易時點 | 大單衝擊效果 |
| **Panel regression** | 多檔股票資料 | 跨股票穩健性 |

## 附錄：計算細節

### 相關係數計算

```python
def pearson_correlation(x, y):
    n = len(x)
    mean_x, mean_y = sum(x)/n, sum(y)/n

    numerator = sum((xi - mean_x) * (yi - mean_y) for xi, yi in zip(x, y))
    denom_x = sqrt(sum((xi - mean_x)**2 for xi in x))
    denom_y = sqrt(sum((yi - mean_y)**2 for yi in y))

    return numerator / (denom_x * denom_y)
```

### 顯著性檢定

```python
def t_test_correlation(r, n):
    t_stat = r * sqrt(n - 2) / sqrt(1 - r**2)
    p_value = 2 * (1 - t_distribution_cdf(abs(t_stat), df=n-2))
    return t_stat, p_value
```

### Lead-Lag 對齊

```python
# Lead: 昨日淨買 vs 今日報酬
lead_corr = correlation(net_buy[:-1], returns[1:])

# Lag: 昨日報酬 vs 今日淨買
lag_corr = correlation(returns[:-1], net_buy[1:])
```
