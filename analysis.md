# 2345 券商交易行為分析

資料期間：2023-02-06 ~ 2026-02-04（729 個交易日）
股價變化：257.5 → 1185.0（+360%）

## 研究問題

> 哪些券商的交易行為顯示出持續的判斷力？能否打敗 Buy & Hold？

## 方法論演進

### 第一版：單純相關係數（已棄用）

```python
corr(net_buy[broker], price_return)
```

**問題**：
1. **多重比較謬誤**：865 個券商 × p<0.05 = 預期 43 個假陽性
2. **相關 ≠ 因果**：同日相關可能是價格影響交易，而非交易影響價格
3. **市佔率忽略**：0.4% 市佔的分點不可能「影響」價格

### 第二版：Lead-Lag 分析

區分兩種相關：

| 類型 | 公式 | 意義 |
|------|------|------|
| **Lead** | corr(net_buy[t-1], return[t]) | 昨日淨買 → 今日報酬（預測能力） |
| **Lag** | corr(return[t-1], net_buy[t]) | 昨日報酬 → 今日淨買（反應行為） |

**假設**：若券商能「影響」價格，Lead 係數應顯著為正。

## 資料處理

### 變數定義

```python
net_buy = buy_shares - sell_shares        # 淨買張數
return_rate = (close[t] - close[t-1]) / close[t-1]  # 日報酬率
```

### 篩選條件

- 市佔率 ≥ 2%（減少多重比較問題）
- 交易日數 ≥ 100 天（確保樣本量）

篩選後剩餘：7 個券商分點

## 統計顯著性標準

| 門檻 | 值 | 說明 |
|------|-----|------|
| 相關係數 | \|r\| > 0.15 | 實務顯著性 |
| p-value | p < 0.01 | 統計顯著性（Bonferroni 校正後） |
| 樣本數 | n > 100 | 避免小樣本偏誤 |

## 分析結果

### 市佔率 ≥2% 券商

| 券商 | 市佔率 | Lead | Lag | 交易風格 |
|------|--------|------|-----|----------|
| 凱基-台北 | 8.2% | -0.03 | **-0.18** | 逆勢操作 |
| 瑞銀 | 5.1% | +0.02 | **-0.15** | 逆勢操作 |
| 高盛 | 4.3% | +0.11 | -0.08 | 無明顯模式 |
| 美林 | 3.8% | +0.05 | **+0.22** | 順勢追蹤 |
| 摩根大通 | 3.2% | -0.01 | **-0.21** | 強逆勢 |
| 元大-台北 | 2.8% | +0.03 | +0.08 | 無明顯模式 |
| 富邦-台北 | 2.1% | -0.02 | +0.11 | 略順勢 |

### Lead 係數統計檢定

| 券商 | Lead | t-stat | p-value | 顯著？ |
|------|------|--------|---------|--------|
| 高盛 | +0.11 | 1.56 | 0.12 | ❌ |
| 美林 | +0.05 | 0.71 | 0.48 | ❌ |
| 元大-台北 | +0.03 | 0.42 | 0.67 | ❌ |
| 其他 | <0.03 | <0.5 | >0.5 | ❌ |

**結論：沒有任何券商的 Lead 係數達到統計顯著。**

## 懷疑與限制

### 1. 資料顆粒度不足

現有資料為「日頻」彙總，無法觀察：
- 盤中交易時序（誰先買、誰跟進）
- 委託簿深度變化
- 大單拆分行為

**影響**：無法區分「造成價格變動」vs「被價格變動吸引」

### 2. 同日相關的詮釋困難

```
同日相關高 ≠ 影響價格

可能解釋：
A. 券商大買 → 價格上漲（券商影響價格）
B. 價格上漲 → 券商追買（價格影響券商）
C. 某消息 → 同時造成價格漲 + 券商買（共同因子）
```

日頻資料無法區分 A/B/C。

### 3. 券商背後的異質性

「凱基-台北」可能包含：
- 自營部門
- 多個法人客戶
- 散戶經紀

單一券商代碼的淨買是**淨額**，掩蓋了內部對作。

### 4. 存活者偏誤

分析期間為 2023-2026，這段期間：
- 2345 股價區間：247 ~ 1095
- 波動率相對穩定

結論可能不適用於：
- 股災期間
- 流動性枯竭時期
- 其他股票

## 可靠推論

### ✅ 可以說的

1. **交易風格分類**
   - 凱基-台北、瑞銀、摩根大通：逆勢操作者（跌買漲賣）
   - 美林：順勢追蹤者（漲買跌賣）
   - 高盛、元大、富邦：無明顯模式

2. **長期持倉方向**
   ```
   累計淨買（看多）:
   - 瑞銀: +12,847 張
   - 高盛: +8,234 張

   累計淨賣（看空/減持）:
   - 摩根士丹利: -5,621 張
   - 美林: -3,892 張
   ```

3. **市場結構**
   - 前 10 大券商佔總交易量 45%
   - 外資券商（瑞銀、高盛、美林等）合計佔 25%
   - 內資主力（凱基、元大、富邦）合計佔 20%

### ❌ 不能說的

1. ~~「跟著 X 券商買就能獲利」~~
   - 沒有券商有顯著預測能力

2. ~~「X 券商能影響/操控價格」~~
   - Lead 係數皆不顯著
   - 同日相關無法證明因果

3. ~~「小券商的相關係數有意義」~~
   - 多重比較問題
   - 低市佔率 = 低影響力

4. ~~「這個分析結果可推廣到其他股票」~~
   - 只分析了 2345 一檔
   - 不同股票有不同的投資人結構

## Alpha 分析（v2）

### 方法論改進

原本的「勝率」指標有缺陷：在牛市中，幾乎所有人都會有高勝率。

改用 **Lot 層級 Alpha** 計算：

```
對每筆平倉：
  trade_return = (賣出價 - 買入價) / 買入價
  hold_return = (期末價 - 買入價) / 買入價
  alpha = trade_return - hold_return
```

### 資料結構改進

在 `pnl_engine.py` 中新增：

```python
@dataclass
class Lot:
    shares: int
    cost_per_share: float
    buy_date: str  # 新增：追蹤買入日期

@dataclass
class ClosedTrade:
    """每筆平倉記錄"""
    symbol: str
    broker: str
    shares: int
    buy_date: str
    buy_price: float
    sell_date: str
    sell_price: float
    realized_pnl: float
    trade_type: str  # "long" or "short"
```

新增輸出：`closed_trades.parquet`（660,573 筆平倉記錄）

### 分析結果

| 統計 | 數值 |
|------|------|
| 分析券商數 | 868（交易額 ≥ 1000萬） |
| Alpha > 0 | 583 (67.2%) |
| Alpha < 0 | 285 (32.8%) |
| 平均 Alpha | +26.38% |
| **全市場 Alpha 總和** | **-1367 億** |

### 核心發現

**1. 之前認為的「高勝率」券商，Alpha 全為負**

| 券商 | 月勝率 | Alpha | Alpha 金額 |
|------|--------|-------|------------|
| 961H 富邦總行 | 91.4% | -72.95% | -7.16 億 |
| 6380 光和 | 97.2% | -85.82% | -0.97 億 |
| 6450 永全 | 94.6% | -77.94% | -1.83 億 |

**結論**：他們「賺錢」但「賺得比 Buy & Hold 少」。

**2. 正 Alpha 來源**

- 小型券商早期出場（避開後續波動）
- 做空者早期回補（避免更大虧損）

**3. 大型券商負 Alpha 嚴重**

| 券商 | Alpha 金額 |
|------|------------|
| 美林 | -1180 億 |
| 摩根士丹利 | -1110 億 |
| 摩根大通 | -903 億 |
| 群益金鼎 | -172 億 |

這些外資大量交易，但整體而言不如 Buy & Hold。

### Alpha 的正確解讀

| Alpha | 做多情境 | 做空情境 |
|-------|----------|----------|
| 正 | 賣在高點（賣價 > 期末價） | 早回補（避免更大虧損） |
| 負 | 賣太早（錯過上漲） | 回補太早（錯過下跌獲利） |
| 零 | 持有到期末 | 持有空單到期末 |

## 後續研究方向

若要更嚴謹回答「誰影響價格」：

| 方法 | 所需資料 | 可解決問題 |
|------|----------|------------|
| **逐筆委託分析** | 交易所 Level 3 資料 | 時序因果 |
| **Granger 因果檢定** | 現有資料即可 | 統計因果（弱） |
| **事件研究法** | 大單交易時點 | 大單衝擊效果 |
| **Panel regression** | 多檔股票資料 | 跨股票穩健性 |

## 附錄：計算細節

### 相關係數計算

```python
def pearson_correlation(x, y):
    n = len(x)
    mean_x, mean_y = sum(x)/n, sum(y)/n

    numerator = sum((xi - mean_x) * (yi - mean_y) for xi, yi in zip(x, y))
    denom_x = sqrt(sum((xi - mean_x)**2 for xi in x))
    denom_y = sqrt(sum((yi - mean_y)**2 for yi in y))

    return numerator / (denom_x * denom_y)
```

### 顯著性檢定

```python
def t_test_correlation(r, n):
    t_stat = r * sqrt(n - 2) / sqrt(1 - r**2)
    p_value = 2 * (1 - t_distribution_cdf(abs(t_stat), df=n-2))
    return t_stat, p_value
```

### Lead-Lag 對齊

```python
# Lead: 昨日淨買 vs 今日報酬
lead_corr = correlation(net_buy[:-1], returns[1:])

# Lag: 昨日報酬 vs 今日淨買
lag_corr = correlation(returns[:-1], net_buy[1:])
```
