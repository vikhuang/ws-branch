# 2345 券商交易行為分析

資料期間：2023-02-06 ~ 2026-02-04（729 個交易日）
股價變化：257.5 → 1185.0（+360%）

## 研究問題

> 哪些券商的交易行為顯示出持續的判斷力？能否打敗 Buy & Hold？

## 方法論演進

### 第一版：單純相關係數（已棄用）

```python
corr(net_buy[broker], price_return)
```

**問題**：
1. **多重比較謬誤**：865 個券商 × p<0.05 = 預期 43 個假陽性
2. **相關 ≠ 因果**：同日相關可能是價格影響交易，而非交易影響價格
3. **市佔率忽略**：0.4% 市佔的分點不可能「影響」價格

### 第二版：Lead-Lag 分析

區分兩種相關：

| 類型 | 公式 | 意義 |
|------|------|------|
| **Lead** | corr(net_buy[t-1], return[t]) | 昨日淨買 → 今日報酬（預測能力） |
| **Lag** | corr(return[t-1], net_buy[t]) | 昨日報酬 → 今日淨買（反應行為） |

**假設**：若券商能「影響」價格，Lead 係數應顯著為正。

## 資料處理

### 變數定義

```python
net_buy = buy_shares - sell_shares        # 淨買張數
return_rate = (close[t] - close[t-1]) / close[t-1]  # 日報酬率
```

### 篩選條件

- 市佔率 ≥ 2%（減少多重比較問題）
- 交易日數 ≥ 100 天（確保樣本量）

篩選後剩餘：7 個券商分點

## 統計顯著性標準

| 門檻 | 值 | 說明 |
|------|-----|------|
| 相關係數 | \|r\| > 0.15 | 實務顯著性 |
| p-value | p < 0.01 | 統計顯著性（Bonferroni 校正後） |
| 樣本數 | n > 100 | 避免小樣本偏誤 |

## 分析結果

### 市佔率 ≥2% 券商

| 券商 | 市佔率 | Lead | Lag | 交易風格 |
|------|--------|------|-----|----------|
| 凱基-台北 | 8.2% | -0.03 | **-0.18** | 逆勢操作 |
| 瑞銀 | 5.1% | +0.02 | **-0.15** | 逆勢操作 |
| 高盛 | 4.3% | +0.11 | -0.08 | 無明顯模式 |
| 美林 | 3.8% | +0.05 | **+0.22** | 順勢追蹤 |
| 摩根大通 | 3.2% | -0.01 | **-0.21** | 強逆勢 |
| 元大-台北 | 2.8% | +0.03 | +0.08 | 無明顯模式 |
| 富邦-台北 | 2.1% | -0.02 | +0.11 | 略順勢 |

### Lead 係數統計檢定

| 券商 | Lead | t-stat | p-value | 顯著？ |
|------|------|--------|---------|--------|
| 高盛 | +0.11 | 1.56 | 0.12 | ❌ |
| 美林 | +0.05 | 0.71 | 0.48 | ❌ |
| 元大-台北 | +0.03 | 0.42 | 0.67 | ❌ |
| 其他 | <0.03 | <0.5 | >0.5 | ❌ |

**結論：沒有任何券商的 Lead 係數達到統計顯著。**

## 懷疑與限制

### 1. 資料顆粒度不足

現有資料為「日頻」彙總，無法觀察：
- 盤中交易時序（誰先買、誰跟進）
- 委託簿深度變化
- 大單拆分行為

**影響**：無法區分「造成價格變動」vs「被價格變動吸引」

### 2. 同日相關的詮釋困難

```
同日相關高 ≠ 影響價格

可能解釋：
A. 券商大買 → 價格上漲（券商影響價格）
B. 價格上漲 → 券商追買（價格影響券商）
C. 某消息 → 同時造成價格漲 + 券商買（共同因子）
```

日頻資料無法區分 A/B/C。

### 3. 券商背後的異質性

「凱基-台北」可能包含：
- 自營部門
- 多個法人客戶
- 散戶經紀

單一券商代碼的淨買是**淨額**，掩蓋了內部對作。

### 4. 存活者偏誤

分析期間為 2023-2026，這段期間：
- 2345 股價區間：247 ~ 1095
- 波動率相對穩定

結論可能不適用於：
- 股災期間
- 流動性枯竭時期
- 其他股票

## 可靠推論

### ✅ 可以說的

1. **交易風格分類**
   - 凱基-台北、瑞銀、摩根大通：逆勢操作者（跌買漲賣）
   - 美林：順勢追蹤者（漲買跌賣）
   - 高盛、元大、富邦：無明顯模式

2. **長期持倉方向**
   ```
   累計淨買（看多）:
   - 瑞銀: +12,847 張
   - 高盛: +8,234 張

   累計淨賣（看空/減持）:
   - 摩根士丹利: -5,621 張
   - 美林: -3,892 張
   ```

3. **市場結構**
   - 前 10 大券商佔總交易量 45%
   - 外資券商（瑞銀、高盛、美林等）合計佔 25%
   - 內資主力（凱基、元大、富邦）合計佔 20%

### ❌ 不能說的

1. ~~「跟著 X 券商買就能獲利」~~
   - 沒有券商有顯著預測能力

2. ~~「X 券商能影響/操控價格」~~
   - Lead 係數皆不顯著
   - 同日相關無法證明因果

3. ~~「小券商的相關係數有意義」~~
   - 多重比較問題
   - 低市佔率 = 低影響力

4. ~~「這個分析結果可推廣到其他股票」~~
   - 只分析了 2345 一檔
   - 不同股票有不同的投資人結構

## Alpha 分析（執行品質）

### 方法論演進

#### v1（已棄用）：與期末價比較

```
alpha = trade_return - (期末價 - 買入價) / 買入價
```

**問題**：把當沖交易跟持有三年比較，邏輯不通。

#### v2（正確）：與同期間市場報酬比較

```
對每筆平倉：
  trade_return = (執行賣價 - 執行買價) / 執行買價
  benchmark_return = (賣出日收盤 - 買入日收盤) / 買入日收盤
  alpha = trade_return - benchmark_return
```

**意義**：衡量執行價格是否優於市場收盤價。

### 資料結構

在 `pnl_engine.py` 中新增：

```python
@dataclass
class Lot:
    shares: int
    cost_per_share: float
    buy_date: str  # 追蹤買入日期

@dataclass
class ClosedTrade:
    """每筆平倉記錄"""
    symbol: str
    broker: str
    shares: int
    buy_date: str
    buy_price: float
    sell_date: str
    sell_price: float
    realized_pnl: float
    trade_type: str  # "long" or "short"
```

新增輸出：`closed_trades.parquet`（660,573 筆平倉記錄）

### 分析結果

| 統計 | 數值 |
|------|------|
| 分析券商數 | 868（交易額 ≥ 1000萬） |
| Alpha > 0 | 247 (28.5%) |
| Alpha < 0 | 621 (71.5%) |
| 平均 Alpha | -0.097% |
| 中位數 Alpha | -0.091% |
| **全市場 Alpha 總和** | **+0.26 億** |

### 核心發現

**1. Alpha 範圍很小（-1.88% ~ +1.72%）**

這是合理的：執行價格與收盤價的差異本來就不大。

**2. 大部分券商（71.5%）執行價格略劣於收盤價**

這符合預期：
- 買入時通常追價（高於收盤）
- 賣出時通常殺價（低於收盤）

**3. 主要券商 Alpha**

| 券商 | Alpha | Alpha 金額 | 解讀 |
|------|-------|------------|------|
| 土銀 | +1.17% | +0.21 億 | 執行價格最優 |
| 美林 | +0.13% | +1.45 億 | 略優（大量交易） |
| 961H 富邦總行 | +0.37% | +0.04 億 | 略優 |
| 群益金鼎 | -0.13% | -0.25 億 | 略劣 |
| 大和國泰 | -0.31% | -0.26 億 | 略劣 |

### Alpha 的正確解讀

| Alpha | 意義 | 來源 |
|-------|------|------|
| 正 | 執行價優於收盤價 | 買在低點、賣在高點（盤中） |
| 負 | 執行價劣於收盤價 | 買在高點、賣在低點（盤中） |
| 零 | 執行價等於收盤價 | 以收盤價成交 |

### 範例計算

```
買入日：2025-10-16   執行買價：1025   收盤價：1000（買貴 2.5%）
賣出日：2026-01-13   執行賣價：1190   收盤價：1180（賣好 0.8%）

交易報酬 = (1190 - 1025) / 1025 = +16.1%
基準報酬 = (1180 - 1000) / 1000 = +18.0%
Alpha = 16.1% - 18.0% = -1.9%
```

**結論**：執行價格比收盤價差了 1.9%，主要因為買入時付了溢價。

### 驗證案例

#### 做空正 Alpha（第一金-中山）

```
開空: 2025-02-12 @ 764.6 (收盤: 732.0) → 比收盤高 32.6 元開空
回補: 2025-03-06 @ 682.4 (收盤: 695.0) → 比收盤低 12.6 元回補

trade_return = (764.6 - 682.4) / 764.6 = +10.76%
benchmark    = (732.0 - 695.0) / 732.0 = +5.05%
Alpha = +5.70%（開空價優於收盤，回補價也優於收盤）
```

#### 做多正 Alpha（土銀）

```
買入: 2025-02-07 @ 758.0 (收盤: 774.0) → 比收盤低 16 元買入
賣出: 2025-03-18 @ 666.0 (收盤: 667.0) → 略低於收盤

trade_return = (666.0 - 758.0) / 758.0 = -12.14%（虧損）
benchmark    = (667.0 - 774.0) / 774.0 = -13.82%（如果用收盤價，虧更多）
Alpha = +1.69%（執行優勢，雖然虧損但比收盤價交易者虧更少）
```

#### 大型外資 Alpha 趨近零（瑞銀）

| 指標 | 數值 |
|------|------|
| 交易筆數 | 1,452 |
| 正 Alpha 交易 | 52.5% |
| 負 Alpha 交易 | 47.5% |
| 整體加權 Alpha | +0.11% |

**原因**：交易量大（1,569億），難以取得執行優勢，正負相抵。

### 近一年 Top 10 正 Alpha（交易額≥1億，筆數≥50）

| 排名 | 券商 | Alpha | 特徵 |
|------|------|-------|------|
| 1 | 第一金-中山 | +1.44% | 純做空，開空價優 |
| 2 | 土銀 | +1.32% | 純做多，賣出價優 |
| 3 | 富邦-新店 | +0.90% | 混合策略 |
| 4 | 台新-高雄 | +0.84% | 混合策略 |
| 5 | 國票-北投 | +0.79% | 純做多 |

## Timing Alpha 分析（擇時能力）

### 與執行 Alpha 的區別

| 指標 | 衡量什麼 | 公式 |
|------|----------|------|
| 執行 Alpha | 盤中執行價格是否優於收盤價 | trade_return - benchmark_return |
| Timing Alpha | 進出時機是否正確 | Σ((net_buy[t-1] - avg) × return[t]) |

### 方法論演進

#### 錯誤版本：avg_position × total_return

```python
passive = avg_position × total_market_return  # 錯！
excess = actual - passive
```

**問題**：混合不同時間的資料，對多空不對稱（牛市中做空自動為正）。

#### 正確版本：去中心化的每日決策

```python
timing_alpha = Σ((net_buy[t-1] - avg_net_buy) × return[t])
```

**意義**：
- 正值：在高報酬日「買得比平均多」→ 正確擇時
- 負值：在高報酬日「買得比平均少」→ 錯誤擇時
- 零值：每天買賣相同 → 無擇時能力

### 與 Lead 相關的關係

```
Lead = corr(net_buy, return)     # 方向一致性（-1 到 +1）
Timing Alpha ≈ Lead × std(net_buy) × n  # 累積貢獻
```

兩者相關係數：+0.29（有獨立資訊）

### 大型券商 Timing Alpha

| 券商 | Timing Alpha | Lead | 方向 | 解讀 |
|------|-------------|------|------|------|
| 高盛 | +531,267 | +0.079 | 做空 | 在漲前回補、跌前開空 |
| 瑞銀 | +272,789 | +0.042 | 做多 | 在漲前加碼、跌前減碼 |
| 群益金鼎 | +135,899 | +0.076 | 做多 | 正確擇時 |
| 摩根大通 | -465,591 | -0.069 | 做多 | 在漲前減碼、跌前加碼 |
| 花旗環球 | -398,325 | -0.093 | 做空 | 錯誤擇時 |

### 高盛案例解析

```
高盛買入後，隔日平均漲跌：+0.43%
高盛賣出後，隔日平均漲跌：+0.11%
市場平均：+0.25%

差異：高盛買入後比賣出後，隔日多漲 +0.32%
```

**結論**：高盛做空做錯了（股價漲 360%），但進出時機是對的。

## Permutation Test（統計顯著性檢定）

### 原理

1. 計算真實的 Timing Alpha
2. 隨機打亂交易日期 1000 次，計算模擬的 Timing Alpha
3. 看真實值在模擬分布中的位置

**解讀**：
- p < 0.05：擇時能力統計顯著（不太可能是運氣）
- p > 0.05：可能只是運氣

### 重點券商結果

| 券商 | Timing Alpha | p-value | 結論 |
|------|-------------|---------|------|
| **高盛** | +531,267 | 0.027 ⭐ | 真的有擇時能力 |
| **群益金鼎** | +135,899 | 0.045 ⭐ | 真的有擇時能力 |
| **花旗環球** | -398,325 | 0.017 ⭐ | 真的很差（反指標） |
| 摩根大通 | -465,591 | 0.065 | 邊緣，可能是運氣 |
| 瑞銀 | +272,789 | 0.236 | 可能是運氣 |
| 美林 | -101,771 | 0.703 | 純運氣 |

### 全市場結果

| 類別 | 數量 | 佔比 |
|------|------|------|
| 正向顯著（擇時真的好） | 28 | 3.2% |
| 負向顯著（擇時真的差） | 23 | 2.7% |
| 不顯著（純運氣） | 813 | 94.1% |

**預期 vs 實際**：
- 預期純靠運氣會有 43 個顯著（5%）
- 實際有 51 個顯著（5.9%）
- 結論：大部分「顯著」可能只是運氣

### 正向顯著 Top 10

| 排名 | 券商 | Timing Alpha | p-value |
|------|------|-------------|---------|
| 1 | 高盛 | +531,267 | 0.038 |
| 2 | 群益金鼎 | +135,899 | 0.042 |
| 3 | 華南永昌 | +106,080 | 0.018 |
| 4 | 兆豐-忠孝 | +65,429 | 0.038 |
| 5 | 國泰-板橋 | +59,144 | 0.012 |
| 6 | 富邦-陽明 | +31,209 | 0.016 |
| 7 | 國票-天祥 | +30,956 | 0.010 |
| 8 | 國票 | +17,351 | 0.008 |
| 9 | 華南永昌-南京 | +16,223 | 0.000 |
| 10 | 元大-台中 | +10,573 | 0.026 |

### 負向顯著 Top 5（反指標）

| 排名 | 券商 | Timing Alpha | p-value |
|------|------|-------------|---------|
| 1 | 花旗環球 | -398,325 | 0.012 |
| 2 | 國泰-新莊 | -76,051 | 0.010 |
| 3 | 凱基-土城 | -52,354 | 0.026 |
| 4 | 凱基-敦北 | -26,765 | 0.008 |
| 5 | 群益金鼎-開元 | -16,322 | 0.004 |

## 券商評估 Scorecard

### 六大評估維度

| 維度 | 指標 | 公式/定義 | 意義 | 好的表現 |
|------|------|-----------|------|----------|
| **1. 方向** | 累計淨買 | Σ(buy - sell) | 做多 or 做空 | 牛市做多、熊市做空 |
| **2. 獲利** | 總 PNL | 已實現 + 未實現 | 最終賺了多少 | 正值越大越好 |
| **3. 執行品質** | 執行 Alpha | trade_return - benchmark_return | 成交價 vs 收盤價 | 正值 = 盤中抓到好價 |
| **4. 擇時能力** | Timing Alpha | Σ((net_buy - avg) × return) | 高報酬日買得多？ | 正值 = 擇時正確 |
| **5. 統計顯著** | p-value | Permutation Test | 運氣 or 實力？ | < 0.05 = 真的有能力 |
| **6. 交易風格** | Lag 相關 | corr(return[t-1], net_buy[t]) | 順勢 or 逆勢 | 無好壞，只是風格 |

### 全市場統計

| 類別 | 數量 | 佔比 |
|------|------|------|
| 獲利券商（PNL > 0） | 501 | 57.3% |
| 執行 Alpha > 0 | 248 | 28.4% |
| Timing Alpha > 0 | 456 | 52.2% |
| **擇時顯著正向** | 26 | 3.0% |
| **擇時顯著負向（反指標）** | 23 | 2.6% |
| 不顯著（純運氣） | 825 | 94.4% |

### 完美券商（同時滿足所有條件）

條件：PNL > 0、Timing 顯著正向、執行 Alpha > 0

| 券商 | PNL | 執行 Alpha | Timing Alpha | p-value |
|------|-----|-----------|--------------|---------|
| 兆豐-忠孝 | +0.42億 | +0.26% | +65,429 | 0.020 |
| 永豐金-羅東 | +0.12億 | +0.06% | +3,456 | 0.005 |
| 國票 | +0.12億 | +0.07% | +17,351 | 0.015 |
| 凱基-東勢 | +0.02億 | +0.06% | +2,570 | 0.030 |
| 華南永昌-民權 | +0.01億 | +0.12% | +1,355 | 0.015 |

### 大型券商總覽

| 券商 | 方向 | PNL | 執行α | Timing | 顯著？ | 風格 |
|------|------|-----|-------|--------|--------|------|
| 瑞銀 | 做多 | +7.98億 | +0.11% | +272,789 | ❌ | 逆勢 |
| 高盛 | 做空 | -11.64億 | -0.01% | +531,267 | ⭐正向 | 逆勢 |
| 摩根士丹利 | 做多 | +61.48億 | +0.13% | +76,401 | ❌ | 逆勢 |
| 美林 | 做多 | +97.97億 | +0.13% | -101,771 | ❌ | 中性 |
| 摩根大通 | 做多 | +83.06億 | +0.09% | -465,591 | ❌ | 中性 |
| 群益金鼎 | 做多 | +23.39億 | -0.13% | +135,899 | ⭐正向 | 順勢 |
| 花旗環球 | 做空 | -50.31億 | -0.18% | -398,325 | ⚠️負向 | 中性 |

### 使用指南

```
判斷一個分點時，依序檢查：

1. 方向判斷對不對？ → PNL > 0？
2. 執行品質好不好？ → 執行 Alpha > 0？
3. 擇時能力有沒有？ → Timing Alpha > 0？
4. 是真的還是運氣？ → p-value < 0.05？
5. 什麼交易風格？   → 順勢/逆勢/中性？
```

## 最終結論

### 三種 Alpha 的關係

| 指標 | 衡量 | 高盛表現 | 摩根大通表現 |
|------|------|---------|-------------|
| PNL | 最終賺賠 | 做空虧錢 | 做多賺錢 |
| 執行 Alpha | 盤中執行品質 | +0.08%（略優） | +0.24%（優） |
| Timing Alpha | 進出時機 | +531,267 ⭐ | -465,591 |

### 投資人啟示

| 發現 | 投資建議 |
|------|---------|
| 94% 的券商擇時是噪音 | 不要盲目跟單任何券商 |
| 只有 ~3% 真的有擇時能力 | 如果要跟，選統計顯著的 |
| 「大」不等於「準」 | 瑞銀、美林都不顯著 |
| 有些券商是反指標 | 花旗環球可以反著做 |
| 方向和擇時是獨立的 | 高盛方向錯但擇時對 |

## 後續研究方向

若要更嚴謹回答「誰影響價格」：

| 方法 | 所需資料 | 可解決問題 |
|------|----------|------------|
| **逐筆委託分析** | 交易所 Level 3 資料 | 時序因果 |
| **Granger 因果檢定** | 現有資料即可 | 統計因果（弱） |
| **事件研究法** | 大單交易時點 | 大單衝擊效果 |
| **Panel regression** | 多檔股票資料 | 跨股票穩健性 |

## 附錄：計算細節

### 相關係數計算

```python
def pearson_correlation(x, y):
    n = len(x)
    mean_x, mean_y = sum(x)/n, sum(y)/n

    numerator = sum((xi - mean_x) * (yi - mean_y) for xi, yi in zip(x, y))
    denom_x = sqrt(sum((xi - mean_x)**2 for xi in x))
    denom_y = sqrt(sum((yi - mean_y)**2 for yi in y))

    return numerator / (denom_x * denom_y)
```

### 顯著性檢定

```python
def t_test_correlation(r, n):
    t_stat = r * sqrt(n - 2) / sqrt(1 - r**2)
    p_value = 2 * (1 - t_distribution_cdf(abs(t_stat), df=n-2))
    return t_stat, p_value
```

### Lead-Lag 對齊

```python
# Lead: 昨日淨買 vs 今日報酬
lead_corr = correlation(net_buy[:-1], returns[1:])

# Lag: 昨日報酬 vs 今日淨買
lag_corr = correlation(returns[:-1], net_buy[1:])
```
